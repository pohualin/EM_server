<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="sql to make groupName case insensitive2" author="ktwery" dbms="postgres, mysql">
        <sql>
            CREATE UNIQUE INDEX uk_client_group_name_client_id ON client_group(lower_case_name,client_id);
        </sql>
    </changeSet>
    <changeSet id="sql to make groupName case insensitive h2" author="ktwery" dbms="h2">
        <sql>
            ALTER TABLE client_group ADD lower_case_name VARCHAR_IGNORECASE AS (LOWER(name));
        </sql>
    </changeSet>
    <changeSet id="sql to make groupName constraint" author="ktwery" dbms="h2">
        <sql>
            ALTER TABLE client_group ADD CONSTRAINT uk_client_group_name_client_id UNIQUE(lower_case_name)
        </sql>
    </changeSet>
    <changeSet id="fix data to be unique" author="ktwery">
        <sql><![CDATA[
		    UPDATE client_group SET name=CONCAT(name, ' ', id)
		    where id in (
			SELECT id FROM client_group cg inner join
			(
				SELECT client_id, lower(name), count(*) FROM client_group
				group by client_id, name
				having count(*) > 1
			) AS DUP ON cg.client_id = DUP.client_id)
	    ]]></sql>
    </changeSet>
</databaseChangeLog>

